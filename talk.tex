\usepackage[utf8]{inputenc}
\usepackage{listings}
\usepackage{textcomp}
\usepackage{fancyvrb}

\title{Exploration Oriented Programmming Nitpicks}
\subtitle{REPL to Production}
\author{Moshe Zadka -- https://cobordism.com}
\date{North Bay Python 2018}
 
\begin{document}
 
\begin{titlepage}
\maketitle
\end{titlepage}

\frame{\titlepage}

\begin{frame}
\frametitle{What is Jupyter?}

\begin{itemize}
\item Web interface
\item Kernel
\item Persistent history
\item Other goodies!
\end{itemize}

\end{frame}

\begin{frame}
\frametitle{Kernel}

\begin{itemize}
\item Handles snippets
\item In-memory state
\item Semi-disposable
\item Tornado event loop
\end{itemize}

\end{frame}

\begin{frame}[fragile]
\frametitle{Magic}

\begin{lstlisting}
%%pdb
\end{lstlisting}

\begin{lstlisting}
%% capture output
...
\end{lstlisting}

\end{frame}

\begin{frame}[fragile]
\frametitle{Managing Kernels}

\begin{lstlisting}
def add_to(kernel_venv, jupyter_venv):
    python = os.path.join(kernel_venv, 'bin', 'python')
    name = os.path.basename(kernel_venv)
    subprocess.check_call([python, '-m',
                           'pip', 'install', 'ipykernel'])
    subprocess.check_call([python, '-m',
                           'ipykernel', 'install',
                           '--name', name,
                           '--display-name', name,
                           '--prefix', venv])
    jupyter = os.path.join(jupyter_venv, 'bin', 'jupyter')
    spec = os.path.join(venv, 'share/jupyter/kernels', name)
    subprocess.check_call([jupyter, 'kernelspec', 'install', spec])
\end{lstlisting}
\end{frame}

\begin{frame}
\frametitle{Security Model}

\begin{itemize}
\item Opaque security token
\item By default, listen only on localhost
\end{itemize}

\end{frame}

\begin{frame}
\frametitle{Notebooks}

\begin{itemize}
\item Editable history
\item Inputs and outputs
\item Code, not state
\end{itemize}

\end{frame}

\begin{frame}[fragile]
\frametitle{Notebooks from the Inside}

\begin{lstlisting}
{
 "cells": [
  { "cell_type": "code",
   ...
    "source": ["1 + 1"]
  }
 ]
 "nbformat": 4,
 "nbformat_minor": 1
}
\end{lstlisting}

\end{frame}

7 minute mark

\begin{frame}
\frametitle{REPL History}
\end{frame}

\begin{frame}[fragile]
\frametitle{Global namespace}

\begin{lstlisting}[frame=single]
some_thing = 15
\end{lstlisting}

\begin{lstlisting}[frame=single]
some_thing * 2
\end{lstlisting}

\begin{lstlisting}[frame=single]
30
\end{lstlisting}

\end{frame}

\begin{frame}[fragile]
\frametitle{Redefining functions}

\begin{lstlisting}[frame=single]
def foo(a):
    return 2 * a
\end{lstlisting}

\begin{lstlisting}[frame=single]
foo(10)
\end{lstlisting}

\begin{lstlisting}[frame=single]
20
\end{lstlisting}

\begin{lstlisting}[frame=single]
def foo(a):
    return 3 * a
\end{lstlisting}

\begin{lstlisting}[frame=single]
30
\end{lstlisting}

\end{frame}

\begin{frame}[fragile]
\frametitle{Immutable data structures}

\begin{lstlisting}[frame=single]
from pyrsistent import v
a = v(1, 2, 3)
\end{lstlisting}

\begin{lstlisting}[frame=single]
def increase_head(stuff):
    return stuff.set(0, stuff[0] + 1)
increase_head(a)
\end{lstlisting}

\begin{lstlisting}[frame=single]
pvector([2, 2, 3])
\end{lstlisting}

\begin{lstlisting}[frame=single]
def increase_tail(stuff):
    return stuff.set(-1, stuff[-1] + 1)
increase_tail(a)
\end{lstlisting}

\begin{lstlisting}[frame=single]
pvector([1, 2, 4])
\end{lstlisting}

\end{frame}

\begin{frame}[fragie]
\frametitle{Verification as testing}

\begin{lstlisting}[frame=single]
# test
x = [1, 2, 3]
y = increase_tail(x)
assert_that(y[2], is_(5))
\end{lstlisting}

\begin{lstlisting}[frame=single]
...
AssertionError: 
Expected: <5>
     but: was <4>
\end{lstlisting}

\end{frame}

\begin{frame}[fragile]
\frametitle{Classes}

\begin{lstlisting}[frame=single]
@attr.s(frozen=True)
class Point:
     x = attr.ib()
     y = attr.ib()
\end{lstlisting}


\end{frame}

\begin{frame}[fragile]
\frametitle{Dispatching}

\begin{lstlisting}[frame=single]
@singledispatch
def abs(thing):
    raise NotImplementedError("Cannot absolute value", thing)
\end{lstlisting}

\begin{lstlisting}[frame=single]
@abs.register(Point)
def abs(pt):
    return (pt.x**2 + pt.y**2) ** 0.5
\end{lstlisting}

\end{frame}

\begin{frame}
\frametitle{Version control}

\begin{lstlisting}
   "execution_count": 1,
   "outputs": [
    {
     "data": {
      "text/plain": [
       "2"
      ]
     },
     "execution_count": 1,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
\end{lstlisting}

\end{frame}

\begin{frame}
\frametitle{Cleaning outputs}

\begin{lstlisting}
with open("something.ipynb") as fpin:
    data = fpin.read()
    parsed = json.loads(data)
    for cell in parsed["cells"]:
        del cell["output"]
        del cell["execution_count"]
with open("something_cleaned.ipynb") as fpout:
    fpout.write(json.dumps(parsed))
\end{lstlisting}

\end{frame}

\begin{frame}
\frametitle{Cleaning outputs}

\begin{itemize}
\item Pre-commit hook
\item Test in CI that re-cleaning gives same result
\item Code review the cleaned file
\end{itemize}

\end{frame}


\begin{frame}

\frametitle{Lint}

\begin{lstlisting}
% jupyter nbconvert --to=python something.ipynb
% flake8 something.py
\end{lstlisting}

\end{frame}

\begin{frame}
\frametitle{Test}

\begin{lstlisting}
with open("something.ipynb") as fpin:
    notebook = json.loads(fpin.read())
with open("something.py", "w") as fpout:
    for cell in notebook["cells"]:
        if ("# pragma: interactive-only" in
            cell["source"]):
            continue
        fpout.write(f"\n{cell['source']}\n")
subprocess.check_output(["pytest", "something.py"])
\end{lstlisting}

\end{frame}


\begin{frame}
\frametitle{Custom diff}

\begin{lstlisting}
# Suitable for use as "git difftool"
def to_lines(fname):
    with open(fname) as fpin:
        contents = json.loads(fpin.read())
    for i, cell in enumerate(contents["cells"]):
        yield f'Cell {i}'
        yield from cell["source"].splitlines()
sys.stdout.writelines(difflib.contextdiff(
    to_lines(os.environ['LOCAL']),
    to_lines(os.environ['REMOTE']),
    'a/' + os.environ['MERGED'],
    'b/' + os.environ['MERGED'],
))
\end{lstlisting}


\end{frame}
%
%\begin{frame}
%\frametitle{Custom merge}
%\end{frame}
%
%21 minute mark
%
%\begin{frame}
%\frametitle{Importing notebooks}
%\end{frame}
%
%\begin{frame}
%\frametitle{Integrating with packages}
%\end{frame}
%
%\begin{frame}
%\frametitle{Producing documentation}
%\end{frame}
%
%\begin{frame}
%\frametitle{Producing documentation}
%\end{frame}
%
%\begin{frame}
%\frametitle{Building wheels}
%\end{frame}
%
%\begin{frame}
%\frametitle{Exporting API}
%\end{frame}
%
%28 minute mark
%
%\begin{frame}
%\frametitle{Code as Successive Approximation}
%\end{frame}
%
%\begin{frame}
%\frametitle{REPL as IDE}
%\end{frame}
%
%\begin{frame}
%\frametitle{Our predecessors}
%Lisp
%Smalltalk
%Logo
%\end{frame}
%
\end{document}
